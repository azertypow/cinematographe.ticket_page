app.factory("TicketService",["$http","$q",function($http,$q){return{get_ticket:function(number,key,callback){var url="/tickets/auth";url+="/number/"+number;url+="/key/"+key;$http({method:"GET",url:url}).success((function(rsp,status){return callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){return callback&&callback(rsp)}))},get_ticket_from_uri:function(uri,callback){var url=ticketack.engine_uri;url+="/fastapi/tickets/from_uri?uri=";url+=uri;$http({method:"GET",url:url,headers:{"X-API-Key":ticketack.api_key}}).success((function(rsp,status){return callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){return callback&&callback(rsp)}))},load_ticket_infos:function(ticket_id,callback){var url="/ticket/view_json";var self=this;if(ticket_id)url+="/uuid/"+ticket_id;if(ticketack.lang){url+="?lang="+ticketack.lang}if(ticketack.context){url+=ticketack.lang?"&"+ticketack.context:"?"+ticketack.context}var httpRequest=$http({method:"POST",url:url}).success((function(rsp,status){rsp=self.update_ticket_from_rsp(rsp);callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){callback&&callback(rsp)}))},update_ticket_from_rsp:function(rsp){rsp.ticket_data={};rsp.ticket_data.activated_at=rsp.activated_at;rsp.ticket_data.activated_pricing=rsp.activated_pricing;rsp.ticket_data.contact=rsp.contact;rsp.ticket_data.bookings=rsp.bookings;rsp.ticket_data.windows=rsp.windows;rsp.available_bookings=this.available_bookings(rsp.ticket_data);return rsp},book:function(screening_id,seat,overbook,callback){var headers={"Content-Type":"application/x-www-form-urlencoded"};var url="/screening/book_on_ticket/"+screening_id;url+="?format=json&";url+="overbook="+(overbook?"true":"false");if(seat){url+="&seat="+seat}if(ticketack.session_id){url+="&PHPSESSID="+ticketack.session_id}if(ticketack.lang){url+="&lang="+ticketack.lang}$http({method:"POST",url:url,headers:headers}).success((function(rsp,status,headers,config){callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){callback&&callback(rsp.flash?rsp.flash.error:null)}))},unbook:function(ticket_id,booking_id,callback){var headers={"Content-Type":"application/x-www-form-urlencoded"};var url="/ticket/cancel_booking_json/"+booking_id;url+="?format=json";if(ticket_id)url+="&uuid="+ticket_id;if(ticketack.session_id){url+="&PHPSESSID="+ticketack.session_id}if(ticketack.lang){url+="&lang="+ticketack.lang}$http({method:"POST",url:url,headers:headers}).success((function(rsp,status,headers,config){callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){callback&&callback(rsp.flash?rsp.flash.error:["Couldn't unbook"])}))},disable_book_mode:function(callback){var headers={"Content-Type":"application/x-www-form-urlencoded"};var url="/ticket/disable_book_mode_json?format=json";if(ticketack.session_id){url+="&PHPSESSID="+ticketack.session_id}$http({method:"GET",url:url,headers:headers}).success((function(rsp,status,headers,config){callback&&callback(null,rsp)})).error((function(rsp,status,headers,config){callback&&callback(rsp.flash?rsp.flash.error:["Couldn't unset the current ticket"])}))},available_bookings:function(ticket){let total=0;let available=0;var reduced=this.windows_reduce(ticket,true);(ticket.windows||[]).forEach((function(window){total+=window.nbookings}));reduced.forEach((function(window){available+=window.nbookings}));return{available:available,total:total}},windows_reduce:function(ticket,filter_expired){let day=null;var reduced=_.map(ticket.windows,(function(win){var cpy=_.clone(win);cpy.screening_ids=[];return cpy}));(ticket.bookings||[]).forEach((function(booking){reduced[booking.window].screening_ids.push(booking.screening_id);reduced[booking.window].nbookings-=1;if("overlap"in reduced[booking.window]&&!booking.ignore_overlap_rules){if(!reduced[booking.window].booked_frames){reduced[booking.window].booked_frames=[]}reduced[booking.window].booked_frames.push({start_at:moment(booking.screening_start_at),stop_at:moment(booking.screening_stop_at)})}if(!day&&!_.isUndefined(reduced[booking.window].same_day)&&reduced[booking.window].same_day)day=moment(booking.screening_start_at).format("YYYY-MM-DD")}));if(day){reduced.filter((function(win){return win.same_day})).forEach((function(win){win.day=day}))}if(!filter_expired)return reduced;return reduced.filter((function(win){return!("stop_at"in win)||moment(win.stop_at).isAfter(moment())}))},windows_match:function(ticket,screening,callback){function overlaps(screening_start_at,screening_stop_at,overlap,booked_frames){screening_start_at=moment(screening_start_at).add(moment.duration(overlap));screening_stop_at=moment(screening_stop_at).subtract(moment.duration(overlap));return booked_frames.reduce(((result,booked_frame)=>result||screening_start_at<booked_frame.stop_at&&screening_stop_at>booked_frame.start_at),false)}var reduced=this.windows_reduce(ticket);for(var i=0;i<reduced.length;i++){var win=reduced[i];if(win.nbookings===0)continue;if(!_.isUndefined(win.booked_frames)&&!(win.screening_ids||[]).includes(screening._id))if(!screening.ignore_overlap_rules&&overlaps(screening.start_at,screening.stop_at,win.overlap,win.booked_frames)){continue}if(_.filter(win.screening_ids,(function(id){return id===screening._id})).length>=(win.nsame_screening||1))continue;if(!_.isUndefined(win.day)){if(win.day===moment(screening.start_at).format("YYYY-MM-DD")){return callback?callback(true):true}continue}else if(win.screening_id&&win.screening_id===screening._id){return callback?callback(true):true}else if(win.start_at<=screening.start_at&&screening.start_at<win.stop_at){return callback?callback(true):true}}return callback?callback(false):false}}}]);
