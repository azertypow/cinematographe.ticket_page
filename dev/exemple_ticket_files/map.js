app.controller("MapCtrl",(function($scope,$http,$modal,$timeout,$window,StorageService,TicketService,BucketService,cart_controller){$scope.ticketack=ticketack;$scope.cart_controller=cart_controller;$scope.map_size="normal";$scope.map_width=948,$scope.map_height=660;$scope.map_classname="";$scope.seat_size=25;$scope.overview_seat_size=18;$scope.show_screening_map=function(screening_id,ticket,show_cart_icon,multiple_select,callbacks,initial_pricing_key,bypass_category_check_on_book,hide_map_modal){$scope.ticket=ticket;$scope.show_cart_icon=show_cart_icon;$scope.multiple_select=multiple_select;$scope.multiple_select_nb={value:0};$scope.in_multiple_select_mode=false;$scope.initial_pricing_key=initial_pricing_key;$scope.bypass_category_check_on_book=!!bypass_category_check_on_book;$scope.hide_map_modal=!!hide_map_modal;if(hide_map_modal){$scope.map_width=$window.innerWidth;$scope.map_height=$window.innerHeight}if(callbacks){["on_close","on_click_on_cart","on_add_to_cart","on_remove_from_cart","on_confirm_bookings","on_release_booking","on_book_on_ticket","on_unbook_on_ticket"].forEach((function(event){if(event in callbacks){$scope[event]=callbacks[event]}}))}$scope.pricings_per_row=$scope.multiple_select?4:5;$scope.pricings={};$scope.nb_items_in_cart=0;$scope.nb_items_added_to_cart=0;$scope.nb_bookings_made=0;$scope.tickets=StorageService.get_tickets();$scope.bookings=[];$scope.step="map";$scope.new_pass={number:null,key:null};$scope.alerts=[];$scope.zones=null;$scope.nb_of_zones=0;$scope.selected_zone=null;$scope.screening_id=screening_id;$scope.screening_json_url=[ticketack.engine_uri,ticketack.api_path,"screenings",$scope.screening_id].join("/");$scope.nocache="";$scope.closeAlerts=function(delay){$timeout((function(){$scope.alerts=[]}),delay)};if(!$scope.hide_map_modal){var modalInstance=$modal.open({templateUrl:"placeMapContent.html",scope:$scope})}$scope.setup_map=function(){if($scope.nb_of_zones==1){$scope.show_zone($scope.zones[_.keys($scope.zones)[0]])}};if(!$scope.hide_map_modal){modalInstance.opened.then((function(){$scope.update_screening_data($scope.setup_map)}));modalInstance.result.then((function(selectedItem){}),(function(){$scope.on_close&&$scope.on_close($scope.nb_items_added_to_cart,$scope.nb_bookings_made,$scope.bookings,(function(){$scope.update_screening_data()}));$scope.update_screening_data($scope.setup_map)}));$scope.close=function(){modalInstance.dismiss("cancel")}}else{$scope.update_screening_data($scope.setup_map)}};$scope.has_bookings=function(){return $scope.bookings.length>0};$scope.has_bookings_without_pricings_or_ticket=function(){return $scope.has_bookings&&$scope.bookings.filter((function(b){return!b.pricing_id&&!b.ticket_id})).length>0};$scope.go_to_map=function(){$scope.step="map"};$scope.go_to_pass=function(){$scope.step="pass"};$scope.go_to_pricings=function(){$scope.step="pricings"};$scope.go_to_results=function(){$scope.step="results"};$scope.show_overview=function(){$scope.selected_zone=null;$scope.pricings=$scope.screening.pricings};$scope.show_zone=function(zone){$scope.selected_zone=zone;$scope.pricings=$scope.selected_zone.pricings;if($scope.ticket&&$scope.ticket.ticket_data&&$scope.ticket.ticket_data.activated_pricing){if($scope.pricings.length==1&&$scope.pricings[0].key==$scope.ticket.ticket_data.activated_pricing.key)$scope.pricings=[]}};$scope.switch_multiple_select_mode=function(){$scope.in_multiple_select_mode=!$scope.in_multiple_select_mode;if(!$scope.in_multiple_select_mode)$scope.multiple_select_nb.value=0};$scope.closeAlert=function(index){$scope.alerts.splice(index,1)};$scope.update_screening_data=function(callback){var httpRequest=$http({method:"GET",url:$scope.screening_json_url+$scope.nocache,headers:{"X-API-Key":ticketack.api_key}}).success((function(rsp,status,headers){globalThis.ticketack.server_load=headers("x-load")||globalThis.ticketack.server_load;var tickettypes=["one-time-pass"];if($scope.ticket){tickettypes.push($scope.ticket.type._id)}rsp.seats={total:BucketService.get_total_seats(rsp.buckets),available:BucketService.get_available_seats(rsp.buckets,tickettypes,Date.now(),ticketack.user_roles),unconfirmed:BucketService.get_unconfirmed_seats(rsp.buckets),confirmed:BucketService.get_confirmed_seats(rsp.buckets),used:BucketService.get_used_seats(rsp.buckets)};$scope.screening=rsp;$scope.map_classname=rsp.cinema_hall.name.replace(/[\W_]+/g,"").toLowerCase();$scope.screening.is_still_bookable=moment($scope.screening.stop_at).isAfter();var nb_allowed_pricings=0;Object.keys($scope.screening.pricings).map((function(pricing,index){if(_.intersection($scope.screening.pricings[pricing].sellers,ticketack.user_roles).length===0){delete $scope.screening.pricings[pricing]}else{delete $scope.screening.pricings[pricing].sellers;nb_allowed_pricings++}}));if(nb_allowed_pricings<=0&&!$scope.ticket||!$scope.screening.is_still_bookable)$scope.screening.seats.available=0;if($scope.screening.seats.total>0&&$scope.screening.is_still_bookable)$scope.screening.seats.occupation_percentage=Math.round(100*($scope.screening.seats.confirmed+$scope.screening.seats.unconfirmed)/$scope.screening.seats.total,1);$scope.nocache="?nocache=true";for(key in $scope.screening.pricings){$scope.screening.pricings[key].key=key}$scope.screening.pricings=_.chain($scope.screening.pricings).mapObject((function(p,key){p.key=key;return p})).sortBy((function(p){return(p.opaque||{}).eshop_sort_weight?p.opaque.eshop_sort_weight:Infinity})).value();$scope.pricings=$scope.screening.pricings;$scope.zones=build_zones($scope.screening);build_overview($scope.zones);$scope.look_for_seats_on_ticket(null,(function(error,seats,ticket){$scope.look_for_seats_in_cart(seats,(function(error,seats,cart){$scope.look_for_seats_in_bookings(seats,(function(error,seats,bookings){_.each($scope.zones,(function(zone){_.each(zone.seats,(function(seat){if(!seat.forbidden&&seat.status!=="booked"){seat.forbidden=seat.status!=="booking"&&has_one_booked_seat_around(seat,$scope.zones)}}))}));$scope.nb_items_in_cart=cart.items.length+$scope.bookings.length;if($scope.selected_zone){$scope.show_zone($scope.zones[$scope.selected_zone.name])}callback&&callback()}))}))}))})).error((function(rsp,status,headers,config){callback&&callback(rsp.flash&&rsp.flash.error?rsp.flash.error:null)}))};$scope.look_for_seats_on_ticket=function(seats,callback){seats=seats||$scope.screening.cinema_hall.map.seats;if(!$scope.ticket){return callback&&callback(null,seats)}TicketService.load_ticket_infos($scope.ticket._id,(function(error,infos){if(error){$scope.alerts.push("An error occured while updating ticket");callback&&callback(error)}else{$scope.ticket.ticket_data.contact=infos.contact;$scope.ticket.ticket_data.bookings=infos.bookings;_.each($scope.ticket.ticket_data.bookings,(function(booking){_.each(seats,(function(s){if(booking.screening_id==$scope.screening._id&&booking.seat==s.label){s.booking_id=booking._id;s.status="booked"}}))}));StorageService.store_ticket(ticket);$scope.tickets=StorageService.get_tickets();callback&&callback(null,seats,$scope.ticket)}}))};$scope.look_for_seats_in_cart=function(seats,callback){seats=seats||$scope.screening.cinema_hall.map.seats;if(!$scope.cart_controller){return callback&&callback(null,seats)}$scope.cart_controller.refresh((function(error,cart){if(!error){_.each(seats,(function(s){var seat_in_cart=_.findWhere(cart.items,{seat:s.label,item_id:$scope.screening._id});if(seat_in_cart){s.index_in_cart=seat_in_cart.id;s.status="booking"}else{delete s.index_in_cart}}))}callback&&callback(null,seats,cart)}))};$scope.look_for_seats_in_bookings=function(seats,callback){seats=seats||$scope.screening.cinema_hall.map.seats;_.each(seats,(function(s){var bookings=Object.values($scope.bookings);var seat_in_bookings=_.findWhere(bookings,{seat:s.label,screening_id:$scope.screening._id});if(seat_in_bookings){s.booking_id=seat_in_bookings._id;s.status="booking"}}));callback&&callback(null,seats,$scope.bookings)};$scope.add_new_pass=function(){$scope.new_pass.error=false;if(!$scope.new_pass.number||!$scope.new_pass.key)$scope.new_pass.error=true;TicketService.get_ticket($scope.new_pass.number,$scope.new_pass.key,(function(err,ticket){if(err||!ticket){$scope.new_pass.error=true}else{StorageService.store_ticket(ticket);$scope.tickets=StorageService.get_tickets();$scope.new_pass.number=null;$scope.new_pass.key=null}}))};$scope.remove_ticket=function(ticket){StorageService.remove_ticket(ticket);$scope.tickets=StorageService.get_tickets()},$scope.validate_cart=function(){window.top.postMessage({action:"tkt::go_to_cart"},"*")};var has_one_booked_seat_around=function(current_seat,zones){return false;var left={x:current_seat.position.x-1,y:current_seat.position.y};var right={x:current_seat.position.x+1,y:current_seat.position.y};var has_one_booked_seat_around=false;_.each(zones,(function(zone){_.each(zone.seats,(function(seat){if(seat.position.x===left.x&&seat.position.y===left.y&&(seat.status==="booked"||seat.status=="booking"&&!seat.index_in_cart&&!seat.booking_id)){has_one_booked_seat_around=true}else if(seat.position.x===right.x&&seat.position.y===right.y&&(seat.status==="booked"||seat.status=="booking"&&!seat.index_in_cart&&!seat.booking_id)){has_one_booked_seat_around=true}}))}));return has_one_booked_seat_around};var build_zones=function(screening){if($window.innerWidth<900){$scope.map_size="small";$scope.seat_size=20}var usable_width=$scope.map_width-$scope.seat_size;var usable_height=$scope.map_height-$scope.seat_size;var zones={};$scope.nb_of_zones=0;_.each(screening.cinema_hall.map.seats,(function(s){var zone_name=s.placing.zone;if(!zones[zone_name]){zones[zone_name]={name:zone_name,seats:[]};$scope.nb_of_zones++}zones[zone_name].seats.push(s)}));_.each(zones,(function(zone,zone_name){var min_x=Infinity,max_x=0,min_y=Infinity,max_y=0;_.each(zone.seats,(function(s){s.position.single_view_x=s.position.x*($scope.seat_size+2);s.position.single_view_y=s.position.y*($scope.seat_size+2);s.position.single_view_x<min_x&&(min_x=s.position.single_view_x);s.position.single_view_x>max_x&&(max_x=s.position.single_view_x);s.position.single_view_y<min_y&&(min_y=s.position.single_view_y);s.position.single_view_y>max_y&&(max_y=s.position.single_view_y)}));var translation_x=(usable_width-(max_x-min_x))/2-min_x,translation_y=(usable_height-(max_y-min_y))/2-min_y;_.each(zone.seats,(function(s){s.position.single_view_x+=translation_x;s.position.single_view_y+=translation_y}));zone.bounds={max_x:max_x,min_x:min_x,max_y:max_y,min_y:min_y};zone.center={x:max_x-(max_x-min_x)/2,y:max_y-(max_y-min_y)/2};max_x+=translation_x;min_x+=translation_x;max_y+=translation_y;min_y+=translation_y;zone.single_view={bounds:{max_x:max_x,min_x:min_x,max_y:max_y,min_y:min_y}};zone.single_view.rows={};_.each(zone.seats,(function(s){zone.single_view.rows[s.placing.row]={label:s.placing.row,x:zone.single_view.bounds.min_x-$scope.seat_size,y:s.position.single_view_y}}));zone.seats.sort((function(a,b){if(a.position.y!=b.position.y)return a.position.y>b.position.y?1:-1;if(a.position.x!=b.position.x)return a.position.x>b.position.x?1:-1;return 0}))}));_.each(zones,(function(zone,zone_name){var zone_seats_categories=_.chain(_.pluck(zone.seats,"category")).uniq().value();zone.pricings=_.filter(screening.pricings,(function(p){return _.contains(zone_seats_categories,p.category)}));if($scope.ticket&&$scope.ticket.ticket_data&&$scope.ticket.ticket_data.activated_pricing)zone.pricings.push($scope.ticket.ticket_data.activated_pricing)}));var ticket_pricing_category=null;if($scope.ticket&&$scope.ticket.ticket_data&&$scope.ticket.ticket_data.activated_pricing)ticket_pricing_category=$scope.ticket.ticket_data.activated_pricing.category;_.each(zones,(function(zone){_.each(zone.seats,(function(seat){if(screening.seats.available==0||!_.findWhere(zone.pricings,{category:seat.category})){seat.forbidden=seat.status==="free"?true:false}}))}));return zones};var build_overview=function(zones){var usable_width=$scope.map_width-$scope.overview_seat_size;var usable_height=$scope.map_height-$scope.overview_seat_size;var overview_min_x=Infinity,overview_max_x=0,overview_min_y=Infinity,overview_max_y=0;_.each(zones,(function(zone,zone_name){_.each(zone.seats,(function(s){s.position.x<overview_min_x&&(overview_min_x=s.position.x);s.position.x>overview_max_x&&(overview_max_x=s.position.x);s.position.y<overview_min_y&&(overview_min_y=s.position.y);s.position.y>overview_max_y&&(overview_max_y=s.position.y)}))}));overview_max_x*=$scope.overview_seat_size+0;overview_max_y*=$scope.overview_seat_size+0;var overview_translation_x=(usable_width-(overview_max_x-overview_min_x))/2-overview_min_x,overview_translation_y=50;_.each(zones,(function(zone,zone_name){zone.overview={bounds:{max_x:zone.bounds.max_x/$scope.seat_size*$scope.overview_seat_size+overview_translation_x,min_x:zone.bounds.min_x/$scope.seat_size*$scope.overview_seat_size+overview_translation_x,max_y:zone.bounds.max_y/$scope.seat_size*$scope.overview_seat_size+overview_translation_y,min_y:zone.bounds.min_y/$scope.seat_size*$scope.overview_seat_size+overview_translation_y}};zone.overview.center={x:zone.overview.bounds.max_x-(zone.overview.bounds.max_x-zone.overview.bounds.min_x)/2,y:zone.overview.bounds.max_y-(zone.overview.bounds.max_y-zone.overview.bounds.min_y)/2};_.each(zone.seats,(function(s){s.position.overview_x=s.position.x*$scope.overview_seat_size+overview_translation_x;s.position.overview_y=s.position.y*$scope.overview_seat_size+overview_translation_y}))}));return zones};$scope.clicked_on_seat=function(seat){if(seat.is_processing){return false}if(seat.forbidden===true&&$scope.ticketack.user_roles.indexOf("on-site")===-1){return false}switch(seat.status){case"free":if($scope.bookings.length>=$scope.ticketack.max_tickets_per_screening){$scope.alerts.push({msg:$scope.ticketack.i18n.max_ticket_per_screening_reached,type:"danger"});$scope.closeAlerts(3e3);return false}else if($scope.nb_items_in_cart>=$scope.ticketack.max_tickets_in_cart){$scope.alerts.push({msg:$scope.ticketack.i18n.max_items_in_cart_reached,type:"danger"});$scope.closeAlerts(3e3);return false}return $scope.add_to_cart([seat]);case"booking":if(seat.booking_id){var booking=$scope.bookings.find((function(b){return b._id===seat.booking_id}));if(booking){$scope.release_booking(booking,seat)}}break;case"booked":if($scope.ticket&&seat.booking_id){return $scope.unbook_on_ticket(seat,seat.booking_id)}return false}};$scope.clicked_on_cart=function(){$scope.on_click_on_cart&&$scope.on_click_on_cart($scope.nb_items_added_to_cart,$scope.nb_bookings_made)};$scope.add_to_cart=function(seats,callback){if($scope.on_add_to_cart){_.each(seats,(function(s){s.is_processing=true}));$scope.on_add_to_cart($scope.screening,seats,null,(function(error,bookings){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}));$scope.closeAlerts(3e3);callback&&callback(error)}else{_.each(bookings,(function(booking){if(seat=_.findWhere(seats,{label:booking.seat})){seat.status="booking";seat.booking_id=booking._id;booking.seat_category=seat.category;$scope.bookings.push(booking)}}));callback&&callback(null,bookings)}_.each(seats,(function(s){s.is_processing=false}));$scope.update_screening_data($scope.setup_map)}))}};$scope.remove_from_cart=function(seat,index){if($scope.on_remove_from_cart){seat.is_processing=true;$scope.on_remove_from_cart(index,(function(error){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}))}else{seat.status="free";delete seat.index_in_cart;$scope.nb_items_added_to_cart--;$scope.nb_items_in_cart--}seat.is_processing=false;$scope.update_screening_data($scope.setup_map)}))}};$scope.release_booking=function(booking,seat){if($scope.on_release_booking){$scope.on_release_booking(booking,(function(error,removed){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}))}else{if(seat){seat.status="free";delete seat.booking_id}$scope.bookings=$scope.bookings.filter((function(b){return b._id!==booking._id}))}}))}};$scope.confirm_bookings=function(callback){if($scope.on_confirm_bookings){$scope.on_confirm_bookings($scope.bookings,(function(error,rsp){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}));$scope.closeAlerts(3e3);callback&&callback(error)}else{rsp.map((function(result){if("added"in result&&result.added)$scope.nb_items_added_to_cart++;else if("confirmed"in result&&result.confirmed)$scope.nb_bookings_made++}));$scope.bookings=[];$scope.results=rsp;$scope.go_to_results();callback&&callback(null,rsp)}}))}};$scope.book_on_ticket=function(seat){if($scope.on_book_on_ticket){seat.is_processing=true;$scope.on_book_on_ticket($scope.screening,seat,(function(error,booking){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}))}else if(booking){$scope.bookings=$scope.bookings.filter((function(b){return b._id!==booking._id}));seat.status="booked";seat.booking_id=booking._id;$scope.nb_bookings_made++}seat.is_processing=false;$scope.update_screening_data($scope.setup_map)}))}};$scope.unbook_on_ticket=function(seat,booking_id){if($scope.on_unbook_on_ticket){seat.is_processing=true;$scope.on_unbook_on_ticket(booking_id,(function(error){if(error){error.forEach((function(msg){$scope.alerts.push({msg:msg,type:"danger"})}))}else{seat.status="free";delete seat.booking_id;$scope.nb_bookings_made--}seat.is_processing=false;$scope.update_screening_data($scope.setup_map)}))}};$scope.do_multiple_selection=function(seat){if(!$scope.in_multiple_select_mode){return false}if($scope.multiple_select_nb.value<=0){return true}var matching_seats=$scope.find_multiple_matching_seats(seat,$scope.multiple_select_nb.value);return $scope.add_to_cart(matching_seats,(function(error,cart_items){if(cart_items){if(cart_items.length===$scope.multiple_select_nb.value){$scope.switch_multiple_select_mode()}else{$scope.multiple_select_nb.value-=cart_items.length}}}))};$scope.find_multiple_matching_seats=function(top_left_seat,nb){var match=[];_.each($scope.selected_zone.seats,(function(s){if(s.position.x>=top_left_seat.position.x&&s.position.y>=top_left_seat.position.y&&s.status=="free"&&!s.forbidden){if(match.length<$scope.multiple_select_nb.value){match.push(s)}}}));return match};$scope.close=function(){window.top.postMessage({action:"tkt::map:close"},"*")};$scope.ticket_can_book=function(ticket){const matching_bucket=BucketService.assign($scope.screening.buckets,ticket.type._id,Date.now(),ticketack.user_roles);if(!matching_bucket)return false;return TicketService.windows_match({windows:ticket.ticket_data.windows,bookings:ticket.ticket_data.bookings},$scope.screening)};var auto_refresh_map=function(){if(ticketack.server_load=="very-low"||ticketack.server_load=="low"){$scope.nocache="";if($scope.step==="map")$scope.update_screening_data($scope.setup_map);var frequency=ticketack.server_load=="very-low"?3e4:6e4;setTimeout(auto_refresh_map,frequency)}else{var frequency=3e5;console.log("server load is "+ticketack.server_load+", skipping map auto-update for "+frequency/1e3+" seconds");setTimeout(auto_refresh_map,frequency)}};setTimeout(auto_refresh_map,3e4);this.show_screening_map=function(screening_id,ticket,show_cart_icon,multiple_select,callbacks,initial_pricing_key,bypass_category_check_on_book,hide_map_modal){return $scope.show_screening_map(screening_id,ticket,show_cart_icon,multiple_select,callbacks,initial_pricing_key,bypass_category_check_on_book,hide_map_modal)};return this}));
